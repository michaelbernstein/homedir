#!/usr/bin/env python

import optparse
import os
import shutil
import subprocess
import sys

__linux_root = '/home/hurley/src/rockhopper'
__build_root = __linux_root + '/build'

def __find_target():
    startdir = curdir = os.getcwd()
    rval = 'unknown'
    while curdir.startswith(__linux_root):
        if os.path.exists(os.path.join(curdir, '.git')):
            rval = os.path.split(curdir)[1]
            break
        curdir, _ = os.path.split(curdir)
        print 'c =', curdir
        os.chdir(curdir)
    os.chdir(startdir)
    return rval

def linux_build(meat, force_reconfig=False, force_rebuild=False):
    git = subprocess.Popen("git status | grep 'On branch' | cut -d' ' -f4",
        shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    branch, _ = git.communicate()
    branch = branch.strip().replace('/', '_')
    if not branch:
        if git.returncode:
            raise Exception, 'Could not determine git branch!'
        branch = 'onetime'

    target = __find_target()
    targetroot = os.path.join(__build_root, target)
    branchroot = os.path.join(targetroot, branch)
    buildroot = os.path.join(branchroot, meat)

    if not os.path.exists(targetroot):
        os.mkdir(targetroot)

    if not os.path.exists(branchroot):
        os.mkdir(branchroot)

    if branch == 'onetime':
        try:
            shutil.rmtree(buildroot)
        except:
            pass

    if os.path.exists(buildroot) and force_rebuild:
        print "=================================================="
        print "make mrproper O=%s" % buildroot
        print "=================================================="
        os.system("make mrproper O=%s" % buildroot)
        print ""
        force_reconfig = True
    elif not os.path.exists(buildroot):
        os.mkdir(buildroot)
        force_reconfig = True

    if force_reconfig:
        print "=================================================="
        print "make %s_defconfig O=%s" % (meat, buildroot)
        print "=================================================="
        os.system("make %s_defconfig O=%s" % (meat, buildroot))
        print ""

    print "=================================================="
    print "make uImage O=%s" % buildroot
    print "=================================================="
    os.system("make uImage O=%s" % buildroot)

if __name__ == '__main__':
    parser = optparse.OptionParser()
    parser.add_option('-f', '--force', dest='force', help='force rebuild',
        default=False, action='store_true')
    parser.add_option('-c', '--config', dest='config', help='force reconfig',
        default=False, action='store_true')

    opts, args = parser.parse_args()

    if not args:
        print 'Need a defconfig to build!'
        sys.exit(1)

    try:
        linux_build(args[0], opts.config, opts.force)
    except Exception, e:
        print str(e)
        sys.exit(1)

    sys.exit(0)
