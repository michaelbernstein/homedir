#!/usr/bin/env python

import getopt, sys, os

def usage():
    print >>sys.stderr, "%s [-a ann] [-c cvs] [-l less] [-n] [-o out] [-s] [-v] [files]" % os.path.basename(sys.argv[0])
    print >>sys.stderr, "    -a ann   Use <ann> as the argument to <cvs> (default annotate)"
    print >>sys.stderr, "    -c cvs    Use <cvs> as the cvs program (default /usr/bin/cvs)"
    print >>sys.stderr, "    -l less   Use <less> for paging the output (default /usr/bin/less)"
    print >>sys.stderr, "    -n        Don't show annotation output after completion"
    print >>sys.stderr, "    -o out    Send output to <out> instead of the default output (/tmp/ann)"
    print >>sys.stderr, "    -s        Use subversion commands by default instead of cvs (trumps -c, -d)"
    print >>sys.stderr, "    -v        Show cvs informational messages while running"
    print >>sys.stderr, ""
    print >>sys.stderr, "If <files> is included, it is a space-separated list of files to annotate"
    print >>sys.stderr, "Otherwise, an annotation is performed on the current directory"
    sys.exit(23)

def cvs_diff():
    show_diff = True
    subversion = False
    verbose = False
    outfile = '/tmp/ann'
    cvs = '/usr/bin/cvs'
    annotate = 'annotate'
    less = '/usr/bin/less'
    
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'a:c:l:no:sv')
    except:
        usage()

    for o, a in opts:
        if o == '-a':
            annotate = a
        elif o == '-c':
            cvs = a
        elif o == '-l':
            less = a
        elif o == '-n':
            show_diff = False
        elif o == '-o':
            outfile = a
        elif o == '-s':
            subversion = True
        elif o == '-v':
            verbose = True
        else:
            print >>sys.stderr, "Unknown option: %s" % o
            usage()

    if subversion:
        cvs = '/opt/local/bin/svn'
        annotate = 'blame'

    cmd = cvs + ' ' + annotate
    if args:
        cmd = cmd + ' ' + ' '.join(args)

    if not verbose:
        cmd = cmd + ' 2> /dev/null'

    os.system(cmd + ' > ' + outfile)

    if show_diff:
        os.system(less + ' ' + outfile)

    sys.exit(0)

if __name__ == '__main__':
    cvs_diff()
