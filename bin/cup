#!/usr/bin/env python

import getopt, sys, os

def usage():
    print >>sys.stderr, "%s [-c cvs] [-s] [-u up] [-v] [files]" % os.path.basename(sys.argv[0])
    print >>sys.stderr, "    -c cvs    Use <cvs> as the cvs program (default /usr/bin/cvs)"
    print >>sys.stderr, "    -s        Use subversion commands by default instead of cvs (trumps -c, -u)"
    print >>sys.stderr, "    -u up     Use <up> as the argument to <cvs> (default update)"
    print >>sys.stderr, "    -v        Show all informational messages while running"
    print >>sys.stderr, ""
    print >>sys.stderr, "If <files> is included, it is a space-separated list of files to update"
    print >>sys.stderr, "Otherwise, an update is performed on the current directory"
    sys.exit(23)

def cvs_update():
    subversion = False
    verbose = False
    cvs = '/usr/bin/cvs'
    update = 'update'
    cvsA = False
    
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'Ac:su:v')
    except:
        usage()

    for o, a in opts:
        if o == '-A':
            cvsA = True
        elif o == '-c':
            cvs = a
        elif o == '-s':
            subversion = True
        elif o == '-u':
            update = a
        elif o == '-v':
            verbose = True
        else:
            print >>sys.stderr, "Unknown option: %s" % o
            usage()

    if subversion:
        cvsA = False
        cvs = '/opt/local/bin/svn'

    cmd = cvs + ' ' + update
    if cvsA:
        cmd = cmd + ' -A'

    if args:
        cmd = cmd + ' ' + ' '.join(args)

    if not verbose:
        cmd = cmd + ' 2> /dev/null'
        cmd = cmd + " | egrep '^[ACDMPU] '"

    cmd = cmd + ' > /tmp/update'

    os.system(cmd)

    os.system('/usr/bin/less /tmp/update')

    sys.exit(0)

if __name__ == '__main__':
    cvs_update()
