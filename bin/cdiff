#!/usr/bin/env python

import getopt, stat, sys, os

def usage():
    print >>sys.stderr, "%s [-c cvs] [-d diff] [-l less] [-n] [-o out] [-r rev1 [-r rev2]] [-s] [-v] [files]" % os.path.basename(sys.argv[0])
    print >>sys.stderr, "    -c cvs    Use <cvs> as the cvs program (default /usr/bin/cvs)"
    print >>sys.stderr, "    -d diff   Use <diff> as the argument to <cvs> (default diff)"
    print >>sys.stderr, "    -l less   Use <less> for paging the output (default /usr/bin/less)"
    print >>sys.stderr, "    -n        Don't show diff output after completion"
    print >>sys.stderr, "    -o out    Send output to <out> instead of the default output (/tmp/diff)"
    print >>sys.stderr, "    -r rev1   Use <rev1> as the early revision for diffing"
    print >>sys.stderr, "    -r rev2   Use <rev2> as the later revision for diffing (requires -r rev1)"
    print >>sys.stderr, "    -s        Use subversion commands by default instead of cvs (trumps -c, -d)"
    print >>sys.stderr, "    -v        Show cvs informational messages while running"
    print >>sys.stderr, ""
    print >>sys.stderr, "If <files> is included, it is a space-separated list of files to diff"
    print >>sys.stderr, "Otherwise, a diff is performed on the current directory"
    sys.exit(23)

def cvs_diff():
    show_diff = True
    subversion = False
    verbose = False
    outfile = '/tmp/diff'
    cvs = '/usr/bin/cvs'
    diff = 'diff'
    less = '/usr/bin/less'
    rev1 = None
    rev2 = None
    
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'c:d:l:no:r:sv')
    except:
        usage()

    for o, a in opts:
        if o == '-c':
            cvs = a
        elif o == '-d':
            diff = a
        elif o == '-l':
            less = a
        elif o == '-n':
            show_diff = False
        elif o == '-o':
            outfile = a
        elif o == '-r':
            if not rev1:
                rev1 = a
            elif not rev2:
                rev2 = a
            else:
                print >>sys.stderr, "Too many -r options"
                usage()
        elif o == '-s':
            subversion = True
        elif o == '-v':
            verbose = True
        else:
            print >>sys.stderr, "Unknown option: %s" % o
            usage()

    if subversion:
        cvs = '/opt/local/bin/svn'
        if rev1 and rev2:
            rev1 = '%s:%s' % (rev1, rev2)
            rev2 = None

    cmd = cvs + ' ' + diff
    if rev1:
        cmd = cmd + ' -r ' + rev1
        if rev2:
            cmd = cmd + ' -r ' + rev2

    if args:
        cmd = cmd + ' ' + ' '.join(args)

    if not verbose:
        cmd = cmd + ' 2> /dev/null'

    os.system(cmd + ' > ' + outfile)

    if show_diff:
        if os.stat(outfile)[stat.ST_SIZE] > 0:
            os.system(less + ' ' + outfile)
        else:
            print 'No changes'

    sys.exit(0)

if __name__ == '__main__':
    cvs_diff()
