;; -*- mode: emacs-lisp -*-
;; emacs by Nick Hurley - Ideas taken from all over the place.
(setq load-path (cons "~/elisp" load-path))
(require 'show-tabs-mode)
(autoload 'javascript-mode "javascript" nil t)

(when window-system
  (require 'color-theme)
  (when (fboundp 'color-theme-initialize)
    (color-theme-initialize))
  (color-theme-dark-laptop))

;; Put autosave files in one place
(defvar autosave-dir "~/.emacs.d/autosaves/")
(make-directory autosave-dir t)
(defun auto-save-file-name-p (filename)
  (string-match "^#.*#$" (file-name-nondirectory filename)))
(defun make-auto-save-file-name ()
  (concat autosave-dir
          (if buffer-file-name
              (concat "#" (file-name-nondirectory buffer-file-name) "#")
            (expand-file-name (concat "#%" (buffer-name) "#")))))

;; Put backup files in one place
(defvar backup-dir "~/.emacs.d/backups/")
(setq backup-directory-alist (list (cons "." backup-dir)))

;; Turn off startup junk
(setq inhibit-startup-echo-area-message t)

(defun nwh/save-buffers-kill-emacs ()
  (interactive)
  (cond ((yes-or-no-p "Really quit? ") (save-buffers-kill-emacs))
	(t (progn
	     (message "Good Choice!")
	     (sit-for 1)
	     (message nil)))))

(defun nwh/ps-print-buffer ()
  "Saves buffer as PS to a user-defined file"
  (interactive)
  (ps-print-buffer (read-from-minibuffer "File to save PS to: ")))

(defun nwh/womanual ()
  "Run WoMan on a user-given command"
  (interactive)
  (woman (read-from-minibuffer "Womanual entry: ")))

(global-set-key (kbd "C-x C-c") 'nwh/save-buffers-kill-emacs)
(global-set-key [f12] 'nwh/ps-print-buffer)
(tool-bar-mode nil)
(menu-bar-mode nil)
(scroll-bar-mode nil)
(setq require-final-newline t)

(define-key global-map "\M-g" 'goto-line)

;; Get rid of .saves files
(setq auto-save-list-file-prefix "/dev/null/")

;; Give me all sorts of nifty stuff
(global-font-lock-mode t)
(show-paren-mode t)
(custom-set-variables
  ;; custom-set-variables was added by Custom.
  ;; If you edit it by hand, you could mess it up, so be careful.
  ;; Your init file should contain only one such instance.
  ;; If there is more than one, they won't work right.
 '(blink-cursor-mode nil)
 '(column-number-mode t)
 '(compile-command "bmake ")
 '(default-major-mode (quote text-mode))
 '(line-number-mode t)
 '(query-user-mail-address nil)
 '(show-paren-delay 0)
 '(show-paren-style (quote mixed))
 '(show-tab-style (quote mark))
 '(show-trailing-whitespace t)
 '(transient-mark-mode t)
 '(user-full-name "Nick Hurley")
 '(user-mail-address "hurley@todesschaf.org"))

;; OpenBSD Kernel Normal Form style parameters for cc-mode.
(c-add-style "openbsd"
	     '((comment-column . 40)
	       (c-basic-offset . 8)
	       (c-comment-only-line-offset . 0)
	       (c-hanging-comment-starter-p . nil)
	       (c-hanging-comment-ender-p . nil)
	       (c-offsets-alist . ((statement-block-intro . +)
				   (knr-argdecl-intro . +)
				   (substatement-open . 0)
				   (label . 0)
				   ;; ???
				   (topmost-intro-cont
				    . openbsd-nkf-topmost-intro-cont)
				   (statement . openbsd-knf-lineup-statement)
				   (statement-cont
				    . openbsd-knf-lineup-statement-cont)
				   (arglist-cont-nonempty
				    . openbsd-knf-arglist-cont-nonempty)
				   (arglist-close
				    . openbsd-knf-arglist-cont-nonempty)))))

(defun openbsd-knf-after-for-loop-p (pos)
  "True if POS is just after `for ('"
  (save-excursion
    (goto-char pos)
    (condition-case ()
        (progn (forward-char -5)        ; (- (length "for ("))
               (looking-at "\\bfor ("))
      (beginning-of-buffer nil))))

(defun openbsd-knf-lineup-statement (langelem)
  "Lineup statement with handling continuation line in for-loop condition."
  (cond ((openbsd-knf-after-for-loop-p (cdr langelem))
         ;; -1 == 4 - 5 == `desired indent level' - `length of "for ("'
         ;; and desired indent level == (/ c-basic-offset 2)
         -1)
        (t 0)))

(defun openbsd-knf-lineup-statement-cont (langelem)
  "Lineup statement-cont with handling continuation line in for-loop\n\
condition."
  (cond ((openbsd-knf-after-for-loop-p (cdr langelem))
         -1)
        ;; 4 == (/ c-basic-offset 2)
        (t 4)))

(defun openbsd-knf-arglist-cont-nonempty (langelem)
  (cond ((save-excursion (goto-char (cdr langelem)) (bolp))
         (save-excursion
           (let ((eol (progn
                        (goto-char (cdr langelem))
                        (end-of-line)
                        (point))))
             (goto-char (cdr langelem))
             (if (search-forward "\t" eol t)
                 (+ (current-column) (/ c-basic-offset 2))
               (/ c-basic-offset 2)))))
        (t (/ c-basic-offset 2))))

(defun openbsd-nkf-topmost-intro-cont (langelem)
  (save-excursion
    (let ((base (save-excursion (goto-char (cdr langelem)) (current-column))))
      (back-to-indentation)
      (- (current-column) base))))

(defun knf-c-mode-common-hook ()
  ;; use KNF for all C like languages
  (c-set-style "openbsd")
  (define-key c-mode-base-map "\C-m" 'newline-and-indent))
(add-hook 'c-mode-common-hook 'knf-c-mode-common-hook)

(defface nwh/tab-whitespace-face
  '((t (:foreground "purple")))
  "Used for calling out tabs in python code")

(defvar nwh/tab-keyword
  '(("\t" . 'nwh/tab-whitespace-face)))

;; Python
(defun my-python-mode-hook()
  (setq indent-tabs-mode nil)
  (turn-on-show-tabs-mode)
  (font-lock-add-keywords nil nwh/tab-keyword)
  (define-key python-mode-map "\C-m" 'newline-and-indent))
(add-to-list 'auto-mode-alist '("\\.py\\.in$" . python-mode))

;; SQL
(add-to-list 'auto-mode-alist '("\\.sql\\.in$" . sql-mode))

;; HTML
(add-to-list 'auto-mode-alist '("\\.html\\.in$" . html-mode))

;; C
(add-to-list 'auto-mode-alist '("\\.c\\.in$" . c-mode))
(add-to-list 'auto-mode-alist '("\\.h\\.in$" . c-mode))

;; ObjC
(add-to-list 'auto-mode-alist '("\\.m$" . objc-mode))

;; All sorts of perl stuff
(add-to-list 'auto-mode-alist '("\\.pl$" . cperl-mode))
(add-to-list 'auto-mode-alist '("\\.plx$" . cperl-mode))
(add-to-list 'auto-mode-alist '("\\.plm$" . cperl-mode))

;; We like lisp and elsip
(add-to-list 'auto-mode-alist '("\\.lisp$" . lisp-mode))
(add-to-list 'auto-mode-alist '("\\.el$" . emacs-lisp-mode))

;; Javascript
(defun my-javascript-mode-hook()
  (setq indent-tabs-mode nil)
  (turn-on-show-tabs-mode)
  (font-lock-add-keywords nil nwh/tab-keyword)
  (define-key javascript-mode-map "\C-m" 'newline-and-indent))
(add-to-list 'auto-mode-alist '("\\.js$" . javascript-mode))

;; Do some hookin' ... erm ...
(add-hook 'font-lock-mode-hook 'font-lock-fontify-buffer)
(add-hook 'text-mode-hook 'my-text-mode-hook)
(add-hook 'python-mode-hook 'my-python-mode-hook)
(add-hook 'javascript-mode-hook 'my-javascript-mode-hook)

;; Make sure subshells are bash
(setq shell-file-name "/bin/zsh")

;; Hopefully, this will wrap text!
(setq text-mode-hook 'turn-on-auto-fill)
(setq-default fill-column 72)

;; End of .emacs
(custom-set-faces
  ;; custom-set-faces was added by Custom.
  ;; If you edit it by hand, you could mess it up, so be careful.
  ;; Your init file should contain only one such instance.
  ;; If there is more than one, they won't work right.
 '(trailing-whitespace ((((class color) (background dark)) (:background "purple")))))
